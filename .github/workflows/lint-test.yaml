name: "Lint+Test"
on:
  pull_request:
  push:
    branches:
      - main
      - devnet
      - testnet
      - aptos-release-*
      - mamoru-testnet

env:
  CARGO_INCREMENTAL: "0"
  CARGO_TERM_COLOR: always
  CARGO_BUILD_JOBS: 16 # limit cargo jobs to by a single job
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUST_TEST_THREADS: 8

# cancel redundant builds
concurrency:
  # cancel redundant builds on PRs (only on PR, not on branches)
  group: ${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.ref) || github.sha }}
  cancel-in-progress: true

jobs:
  rust-lint:
    runs-on: self-hosted
    steps:
      - uses: webfactory/ssh-agent@v0.6.0
        with:
          ssh-private-key: |
            ${{ secrets.MAMORU_CORE_KEY }}
            ${{ secrets.VALIDATION_CHAIN_KEY }}
      - uses: actions/checkout@v3
      - uses: ./.github/actions/rust-setup
      - run: cargo install cargo-sort --force
      - run: scripts/rust_lint.sh --check

  rust-doc-test:
    runs-on: self-hosted
    steps:
      - uses: webfactory/ssh-agent@v0.6.0
        with:
          ssh-private-key: |
            ${{ secrets.MAMORU_CORE_KEY }}
            ${{ secrets.VALIDATION_CHAIN_KEY }}
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # get all the history because cargo xtest --change-since origin/main requires it.
      - uses: ./.github/actions/rust-setup
      - run: cargo test --locked --doc --workspace --exclude aptos-node-checker

  rust-unit-test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # get all the history because cargo xtest --change-since origin/main requires it.
      - uses: webfactory/ssh-agent@v0.6.0
        with:
          ssh-private-key: |
            ${{ secrets.MAMORU_CORE_KEY }}
            ${{ secrets.VALIDATION_CHAIN_KEY }}
      - run: sudo service docker start || true && docker run --detach -p 5432:5432 cimg/postgres:14.2
      - uses: ./.github/actions/rust-setup
      - uses: taiki-e/install-action@v1.5.6
        with:
          tool: nextest
      - run: scripts/dev_setup.sh -b -p -y -P -J
      - run: |
          cargo nextest run --profile ci --locked --workspace --retries 3 --no-fail-fast \
            --exclude smoke-test \
            --exclude aptos-testcases \
            --exclude generate-format \
            --exclude aptos-forge
        env:
          INDEXER_DATABASE_URL: postgresql://postgres@localhost/postgres
          RUST_MIN_STACK: 4297152
          MVP_TEST_ON_CI: true
          SOLC_EXE: /home/runner/bin/solc
          Z3_EXE: /home/runner/bin/z3
          CVC5_EXE: /home/runner/bin/cvc5
          DOTNET_ROOT: /home/runner/.dotnet
          BOOGIE_EXE: /home/runner/.dotnet/tools/boogie

  rust-smoke-test:
    runs-on: self-hosted
    needs: rust-unit-test
    steps:
      - uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.6.0
        with:
          ssh-private-key: |
            ${{ secrets.MAMORU_CORE_KEY }}
            ${{ secrets.VALIDATION_CHAIN_KEY }}
      - run: sudo service docker start || true && docker run --detach -p 5432:5432 cimg/postgres:14.2

      - uses: ./.github/actions/rust-setup
      - uses: taiki-e/install-action@v1.5.6
        with:
          tool: nextest
      # prebuild aptos-node binary, so that tests don't start before node is built.
      # also prebuild aptos-node binary as a separate step to avoid feature unification issues
      # --test-threads is intentionally set to reduce resource contention in ci jobs. Increasing this, increases job failures and retries.
      - run: cargo build --locked --package=aptos-node --features=failpoints,indexer --release && LOCAL_SWARM_NODE_RELEASE=1 cargo nextest run --release --profile ci --package smoke-test --test-threads 3 --retries 3
        env:
          INDEXER_DATABASE_URL: postgresql://postgres@localhost/postgres
